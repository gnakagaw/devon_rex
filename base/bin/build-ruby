#!/bin/bash
set -euo pipefail

[[ $(whoami) = "$RUNNER_USER" ]] || (echo 'Unexpected running user!' ; exit 1)

# Install rbenv
git clone --branch "$DEVON_REX_RBENV_VERSION" --single-branch \
    https://github.com/rbenv/rbenv.git ~/.rbenv
cd ~/.rbenv
src/configure
make -j "$(nproc)" -C src
cat <<'EOF' >> ~/.bash_profile
export PATH="$HOME/.rbenv/bin:$PATH"
eval "$(rbenv init -)"
EOF
. ~/.bash_profile
rbenv -v

# Install ruby-build
RBENV_ROOT=$(rbenv root)
mkdir -p "${RBENV_ROOT}/plugins"
git clone --branch "v${DEVON_REX_RUBY_BUILD_VERSION}" --single-branch \
    https://github.com/rbenv/ruby-build.git "${RBENV_ROOT}/plugins/ruby-build"
cd "${RBENV_ROOT}/plugins/ruby-build"

# Install Ruby
rbenv install "$GLOBAL_RUBY_VERSION"
rbenv global "$GLOBAL_RUBY_VERSION"
rbenv versions
[[ $(ruby -e 'puts RUBY_VERSION') = "$GLOBAL_RUBY_VERSION" ]] || (echo 'Unexpected Ruby version!' ; exit 1)
cat<<'EOF' >> ~/.gemrc
install: --no-document
update: --no-document
EOF
ruby -v

# NOTE: Install bundler v1 as well as v2 because runner applications need them
#       in order to parse both versions of Gemfile.lock.
#       See https://bundler.io/blog/2019/01/03/announcing-bundler-2.html
gem install bundler:"$BUNDLER1_VERSION"
gem install bundler:"$BUNDLER2_VERSION"
[[ $(bundle -v) = "Bundler version ${BUNDLER2_VERSION}" ]] || (echo 'Unexpected Bundler version!' ; exit 1)
bundle -v
