FROM debian:buster-20200224

<%= ERB.new(File.read('base/Dockerfile.env.erb')).result %>
<%= ERB.new(File.read('base/Dockerfile.prepare.erb')).result %>

RUN /tmp/devon_rex_work/build-ruby

# Install Java
ENV JAVA_VERSION <%= ENV.fetch('JAVA_VERSION') %>
ENV PATH /usr/local/java/bin:${PATH}
ARG JAVA_BINARY_URL=https://download.java.net/java/GA/jdk${JAVA_VERSION}/e482c34c86bd4bf8b56c0b35558996b9/10/GPL/openjdk-${JAVA_VERSION}_linux-x64_bin.tar.gz
ARG JAVA_BINARY_FILE=openjdk-${JAVA_VERSION}_linux-x64_bin.tar.gz
RUN curl -fsSLO --compressed "${JAVA_BINARY_URL}" && \
    curl -fsSL  --compressed "${JAVA_BINARY_URL}.sha256" | \
      xargs -I {} echo "{} *${JAVA_BINARY_FILE}" | \
      sha256sum --check --strict && \
    mkdir -p /usr/local/java && \
    tar -xzf "${JAVA_BINARY_FILE}" -C /usr/local/java --strip-components=1 && \
    rm "${JAVA_BINARY_FILE}"

# Install Maven
ENV MAVEN_VERSION <%= ENV.fetch('MAVEN_VERSION') %>
ENV PATH /usr/local/maven/bin:$PATH
ARG MAVEN_BINARY_URL=https://www.apache.org/dist/maven/maven-3/${MAVEN_VERSION}/binaries/apache-maven-${MAVEN_VERSION}-bin.tar.gz
ARG MAVEN_BINARY_FILE=apache-maven-${MAVEN_VERSION}-bin.tar.gz
RUN curl -fsSLO --compressed "${MAVEN_BINARY_URL}" && \
    curl -fsSL  --compressed "${MAVEN_BINARY_URL}.sha512" | \
      xargs -I {} echo "{} *${MAVEN_BINARY_FILE}" | \
      sha512sum --check --strict && \
    mkdir -p /usr/local/maven && \
    tar -xzf "${MAVEN_BINARY_FILE}" -C /usr/local/maven --strip-components 1 && \
    rm "${MAVEN_BINARY_FILE}"

<%= ERB.new(File.read('base/Dockerfile.cleanup.erb')).result %>

CMD java -version && javac -version && mvn -v
