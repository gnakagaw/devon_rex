#!/bin/bash
set -euo pipefail

export PREFIX=/usr/local

# Install ruby-build
git clone --branch "v${DEVON_REX_RUBY_BUILD_VERSION}" --single-branch \
    https://github.com/rbenv/ruby-build.git \
    /tmp/ruby-build
/tmp/ruby-build/install.sh
cd ~
rm -rf /tmp/ruby-build
[[ $(ruby-build --version) = "ruby-build ${DEVON_REX_RUBY_BUILD_VERSION}" ]] || (echo 'Unexpected ruby-build version!' ; exit 1)
ruby-build --version

# Install Ruby
ruby-build "$GLOBAL_RUBY_VERSION" "$PREFIX"
[[ $(ruby -e 'puts RUBY_VERSION') = "$GLOBAL_RUBY_VERSION" ]] || (echo 'Unexpected Ruby version!' ; exit 1)
ruby -v

# Update `gem` command
gem update --system
gem environment

# NOTE: Install bundler v1 as well as v2 because runner applications need them
#       in order to parse both versions of Gemfile.lock.
#       See https://bunndler.io/blog/2019/01/03/announcing-bundler-2.html
gem install bundler:"${BUNDLER1_VERSION}"
gem install bundler:"${BUNDLER2_VERSION}"
gem list bundler
[[ $(bundle -v) = "Bundler version ${BUNDLER2_VERSION}" ]] || (echo 'Unexpected Bundler version!' ; exit 1)
bundle -v
